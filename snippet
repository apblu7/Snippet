@echo off
chcp 65001 > nul
setlocal

set TARGET_BAT=C:\HUNESION\i-oneNGS\deploy-ets.bat
set LOG_FILE=C:\HUNESION\i-oneNGS\deploy-ets.log
set SNAKETAIL_EXE=C:\Tools\SnakeTail\SnakeTail.exe
set VBS_FILE=%TEMP%\run-deploy-hidden.vbs
set DEPLOY_WINDOW_TITLE=deploy-ets-hidden

if exist "%LOG_FILE%" del "%LOG_FILE%"

rem 1. SnakeTail 실행
start "SnakeTail" "%SNAKETAIL_EXE%" -f "%LOG_FILE%"

rem 2. VBS 파일 생성 (deploy-ets.bat을 숨김 실행, 창 없음)
> "%VBS_FILE%" (
    echo Set WshShell = CreateObject("WScript.Shell")
    echo WshShell.Run "cmd /c start ""%DEPLOY_WINDOW_TITLE%"" cmd /c """"%TARGET_BAT%"" ^>^> ""%LOG_FILE%"" 2^>^&1""", 0, False
)

rem 3. VBS 실행
cscript //nologo "%VBS_FILE%"

rem 4. deploy CMD PID 추적
set CMD_PID=
for /f "tokens=2 delims=," %%A in ('tasklist /v /fo csv ^| findstr /i "%DEPLOY_WINDOW_TITLE%"') do (
    set CMD_PID=%%~A
)

rem 5. SnakeTail 감시
:WAIT_SNAKETAIL
tasklist /fi "imagename eq SnakeTail.exe" | find /i "SnakeTail.exe" > nul
if %errorlevel% equ 0 (
    timeout /t 2 > nul
    goto WAIT_SNAKETAIL
)

echo [INFO] SnakeTail 종료됨. 배포 스크립트 종료 처리 중...

if defined CMD_PID (
    taskkill /pid %CMD_PID% /f > nul 2>&1
)

del "%VBS_FILE%" > nul 2>&1
exit