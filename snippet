#!/bin/bash

KEY="private.pem"
OUT="private.xml"

# 추출 함수: 시작 ~ 공백 줄 전까지 블록 추출 후 HEX -> BASE64
extract_block() {
    awk "/$1:/{flag=1;next}/^[^ ]/{flag=0}flag" "$2" | tr -d ' \n:' | xxd -r -p | base64
}

# 전체 텍스트 추출 (미리 파싱)
TEXT_DUMP=$(openssl rsa -in "$KEY" -text -noout)

# 각 파라미터 추출
MODULUS=$(echo "$TEXT_DUMP" | awk '/modulus:/{flag=1;next}/publicExponent/{flag=0}flag' | tr -d ' \n:' | xxd -r -p | base64)
EXPONENT=$(echo "$TEXT_DUMP" | grep publicExponent | awk '{print $2}' | xargs printf "%x" | xxd -r -p | base64)
D=$(extract_block "privateExponent" <(echo "$TEXT_DUMP"))
P=$(extract_block "prime1" <(echo "$TEXT_DUMP"))
Q=$(extract_block "prime2" <(echo "$TEXT_DUMP"))
DP=$(extract_block "exponent1" <(echo "$TEXT_DUMP"))
DQ=$(extract_block "exponent2" <(echo "$TEXT_DUMP"))
IQ=$(extract_block "coefficient" <(echo "$TEXT_DUMP"))

# XML 출력
cat > "$OUT" <<EOF
<RSAKeyValue>
  <Modulus>$MODULUS</Modulus>
  <Exponent>$EXPONENT</Exponent>
  <P>$P</P>
  <Q>$Q</Q>
  <DP>$DP</DP>
  <DQ>$DQ</DQ>
  <InverseQ>$IQ</InverseQ>
  <D>$D</D>
</RSAKeyValue>
EOF

echo "[완료] private.xml 생성됨 → $OUT"