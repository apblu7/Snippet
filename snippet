@echo off
chcp 65001 > nul
setlocal

set TARGET_BAT=C:\HUNESION\i-oneNGS\deploy-ets.bat
set LOG_FILE=C:\HUNESION\i-oneNGS\deploy-ets.log
set SNAKETAIL_EXE=C:\Tools\SnakeTail\SnakeTail.exe
set TEE_BAT=%TEMP%\inline-tee.bat

rem tee.bat 자동 생성
> "%TEE_BAT%" (
    echo @echo off
    echo setlocal
    echo set LOG_FILE=%%1
    echo :loop
    echo set "line="
    echo set /p line=
    echo if defined line (
    echo   echo %%line%%
    echo   echo %%line%% ^>> "%%LOG_FILE%%"
    echo   goto loop
    echo )
)

if exist "%LOG_FILE%" del "%LOG_FILE%"

rem SnakeTail 실행
start "SnakeTail" "%SNAKETAIL_EXE%" -f "%LOG_FILE%"

rem 배포 배치 실행 + tee로 콘솔+로그 동시 출력
call "%TARGET_BAT%" | call "%TEE_BAT%" "%LOG_FILE%"

rem tee 정리
del "%TEE_BAT%" > nul 2>&1

exit /b