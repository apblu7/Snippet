@echo off
chcp 65001 > nul
setlocal

rem 경로 설정
set TARGET_BAT=C:\HUNESION\i-oneNGS\deploy-ets.bat
set LOG_FILE=C:\HUNESION\i-oneNGS\deploy-ets.log
set SNAKETAIL_EXE=C:\Tools\SnakeTail\SnakeTail.exe
set VBS_TEMP_FILE=%TEMP%\run-deploy-hidden.vbs
set DEPLOY_WINDOW_TITLE=deploy-ets-hidden

rem 기존 로그 삭제
if exist "%LOG_FILE%" del "%LOG_FILE%"

rem SnakeTail 실행
start "SnakeTail" "%SNAKETAIL_EXE%" -f "%LOG_FILE%"

rem VBS Base64 본문 저장
> "%TEMP%\vbs.b64" (
    echo U2V0IFdzaFNoZWxsID0gQ3JlYXRlT2JqZWN0KCJXU2NyaXB0LlNoZWxsIikNCldzaFNoZWxs
    LlJ1biAiY21kIC9jIHN0YXJ0ICIlREVQTE9ZX1dJTkRPV19USVRMRSUiIGNtZCAvYyAiIiIlVEFS
    R0VUX0JBVCIlIiAiICZndDsgIiIlTE9HX0ZJTEUlIiIgMiZndDsmMSIsIDAsIEZhbHNl
)

rem Base64 → VBS 복호화
certutil -f -decode "%TEMP%\vbs.b64" "%VBS_TEMP_FILE%" > nul 2>&1
del "%TEMP%\vbs.b64" > nul 2>&1

rem 변수를 VBS에 치환한 명령 실행
setlocal enabledelayedexpansion
set VBS_CALL=cmd /c start "%DEPLOY_WINDOW_TITLE%" cmd /c ""%TARGET_BAT%" >> "%LOG_FILE%" 2>>&1""
cscript //nologo "%VBS_TEMP_FILE%" "%DEPLOY_WINDOW_TITLE%" "%TARGET_BAT%" "%LOG_FILE%"
endlocal

rem deploy CMD PID 찾기
set CMD_PID=
for /f "tokens=2 delims=," %%A in ('tasklist /v /fo csv ^| findstr /i "%DEPLOY_WINDOW_TITLE%"') do (
    set CMD_PID=%%~A
)

rem SnakeTail 감시 루프
:WAIT_SNAKETAIL
tasklist /fi "imagename eq SnakeTail.exe" | find /i "SnakeTail.exe" > nul
if %errorlevel% equ 0 (
    timeout /t 2 > nul
    goto WAIT_SNAKETAIL
)

echo [INFO] SnakeTail 종료됨. 배포 CMD 종료 중...
if defined CMD_PID (
    taskkill /pid %CMD_PID% /f > nul 2>&1
)

del "%VBS_TEMP_FILE%" > nul 2>&1
exit