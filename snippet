@echo off
chcp 65001 > nul
setlocal

set TARGET_BAT=C:\HUNESION\i-oneNGS\deploy-ets.bat
set LOG_FILE=C:\HUNESION\i-oneNGS\deploy-ets.log
set SNAKETAIL_EXE=C:\Tools\SnakeTail\SnakeTail.exe

rem 기존 로그 삭제
if exist "%LOG_FILE%" del "%LOG_FILE%"

rem SnakeTail 실행 (별도 프로세스)
start "SnakeTail" "%SNAKETAIL_EXE%" -f "%LOG_FILE%"

rem 배치 실행 (로그 리디렉션)
echo [INFO] 배포 배치 실행 시작 >> "%LOG_FILE%"
call "%TARGET_BAT%" >> "%LOG_FILE%" 2>&1
echo [INFO] 배포 배치 실행 완료 >> "%LOG_FILE%"

rem SnakeTail 살아 있는지 감시 루프
:WAIT_SNAKETAIL
tasklist /fi "imagename eq SnakeTail.exe" | find /i "SnakeTail.exe" > nul
if %errorlevel% equ 0 (
    timeout /t 2 > nul
    goto WAIT_SNAKETAIL
)

echo [INFO] SnakeTail 종료 감지됨. run-and-tail도 종료합니다.
exit