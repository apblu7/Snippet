@echo off
setlocal enabledelayedexpansion

set TARGET_BAT=.\ppk-tomcat-log-ets.bat
set LOG_FILE=.\ppk-tomcat-log-ets.bat.log
set TAIL_MARK=MY_TAIL_JOB
set SNAKETAIL_EXE=C:\경로\baretail.exe

if exist "%LOG_FILE%" del "%LOG_FILE%"

rem === 원격 tail 실행 (명령줄에 키워드 심기) ===
start "" powershell -NoExit -Command "Start-Process cmd -ArgumentList '/k call \"%TARGET_BAT%\" %TAIL_MARK%' -WindowStyle Normal"

rem === baretail 실행 ===
start "" "%SNAKETAIL_EXE%" "%LOG_FILE%"

rem === baretail 창을 수동으로 닫으면 다음 실행 ===
pause

rem === 명령줄 키워드 기준으로 프로세스 종료 ===
powershell -Command "Get-WmiObject Win32_Process | Where-Object { $_.CommandLine -like '*%TAIL_MARK%*' } | ForEach-Object { Stop-Process -Id $_.ProcessId -Force }"

exit /b