@ControllerAdvice(basePackages = "com.example.api.controller") // 여기에 원하는 패키지
public class HeaderValidationAdvice {

    private final CustomAuthProperties authProperties;

    public HeaderValidationAdvice(CustomAuthProperties authProperties) {
        this.authProperties = authProperties;
    }

    @ModelAttribute
    public void validateHeader(HttpServletRequest request, HandlerMethod handlerMethod) {
        Method method = handlerMethod.getMethod();
        RequireHeaderValidation annotation = method.getAnnotation(RequireHeaderValidation.class);

        if (annotation != null) {
            String controllerName = handlerMethod.getBeanType().getSimpleName(); // 예: ExternalApiController
            String methodName = method.getName();                                 // 예: getData
            String keyId = annotation.keyId();                                    // 예: user-key

            String expectedValue = authProperties.getExpectedKey(controllerName, methodName, keyId);
            String actualValue = request.getHeader(keyId);

            if (!Objects.equals(expectedValue, actualValue)) {
                throw new ResponseStatusException(HttpStatus.FORBIDDEN, "헤더 키 값이 유효하지 않음");
            }
        }
    }
}