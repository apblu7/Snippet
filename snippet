@ControllerAdvice(basePackages = "com.example.api.controller")
public class HeaderValidationAdvice {

    private final Properties authHeaderProperties;

    public HeaderValidationAdvice(@Qualifier("authHeaderProperties") Properties authHeaderProperties) {
        this.authHeaderProperties = authHeaderProperties;
    }

    @ModelAttribute
    public void validateHeader(HttpServletRequest request, HandlerMethod handlerMethod) {
        Method method = handlerMethod.getMethod();
        RequireHeaderValidation annotation = method.getAnnotation(RequireHeaderValidation.class);

        if (annotation != null) {
            String controller = handlerMethod.getBeanType().getSimpleName(); // ex: ExternalApiController
            String methodName = method.getName(); // ex: getData
            String keyId = annotation.keyId(); // ex: user-key
            String actualValue = request.getHeader(keyId);

            String propertyKey = controller + "." + methodName + "." + keyId;
            String expectedValue = authHeaderProperties.getProperty(propertyKey);

            if (!Objects.equals(expectedValue, actualValue)) {
                throw new ResponseStatusException(HttpStatus.FORBIDDEN, "인증 실패: 헤더 값이 일치하지 않습니다");
            }
        }
    }
}